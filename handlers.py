import os

from telebot import types
from telebot.types import InlineKeyboardButton, InlineKeyboardMarkup


from app.bot import ZeroFoodBot
from builders.main_menu_builder import MainMenuBuilder
from keyboards.inline_keyboards import get_dish_keyboard, get_continue_checkout, get_dish_keyboard_with_add, select_payment_method_keyboard, select_order_to_change_status
from config import DEFAULT_IMG_PATH
from models.enums import OrderStatus, PaymentMethod

# –•—Ä–∞–Ω–∏–º –≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
user_states = {}

def init_handlers(bot: ZeroFoodBot) -> None:
    def show_categories(message: types.Message) -> None:
        print("show_categories")
        if not bot.category_menu_builder:
            bot.send_message(chat_id=message.chat.id, text="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")
            return
        markup: InlineKeyboardMarkup = bot.category_menu_builder.build_menu()
        bot.send_message(chat_id=message.chat.id, text="–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é:", reply_markup=markup)

    # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–∫–∞–∑–æ–≤
    def show_orders(message: types.Message) -> None:
        orders = bot.get_order_repository().get_all_by_user(message.chat.id)
        bot.send_message(message.chat.id, "–í–∞—à–∏ –∑–∞–∫–∞–∑—ã:")
        for order in orders:
            if order.status == OrderStatus.IN_CART:
                continue
            bot.send_message(message.chat.id, order.get_order_text())

    # –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∫–æ—Ä–∑–∏–Ω—ã
    def show_cart(message: types.Message) -> None:
        print("show_cart")
        user_id = message.chat.id

        # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–π –∑–∞–∫–∞–∑ —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "IN_CART"
        order = bot.get_order_repository().get_in_cart(user_id)

        if not order or not order.items:
            # –ï—Å–ª–∏ –Ω–µ—Ç –∑–∞–∫–∞–∑–∞ –∏–ª–∏ –æ–Ω –ø—É—Å—Ç–æ–π
            bot.send_message(user_id, "üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.")
            return

        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å–æ —Å–ø–∏—Å–∫–æ–º –±–ª—é–¥
        total = 0
        text = "üõí <b>–í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞:</b>\n\n"
        for item in order.items:
            subtotal = item.quantity * item.dish_price
            total += subtotal
            text += f"üçΩ {item.dish_name} x{item.quantity} ‚Äî {subtotal}‚ÇΩ\n"
        text += f"\nüí∞ <b>–ò—Ç–æ–≥–æ:</b> {total}‚ÇΩ"

        # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑"
        markup = InlineKeyboardMarkup().add(
            InlineKeyboardButton("‚úÖ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑", callback_data="confirm_order")
        )
        bot.send_message(user_id, text, parse_mode='HTML', reply_markup=markup)

    # –ó–∞–ø—Ä–æ—Å –æ—Ç–∑—ã–≤–∞
    def leave_review(message: types.Message) -> None:
        print("leave_review")
        user_id = message.chat.id
        user_states[user_id] = "awaiting_review"
        bot.send_message(message.chat.id, "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤:")
        return

    # –§—É–Ω–∫—Ü–∏—è –∞–¥–º–∏–Ω–∞ - –≤—ã–≤–æ–¥ –≤—Å–µ—Ö –æ—Ç–∑—ã–≤–æ–≤
    def admin_reviews(message: types.Message) -> None:
        print(f"admin_reviews {message.from_user.id} {message.from_user.username}")
        from config import ADMINS

        user_id = message.chat.id

        if user_id not in ADMINS:
            bot.send_message(message.chat.id, "–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ —ç—Ç–æ–π –∫–æ–º–∞–Ω–¥–µ.")
            return

        reviews = bot.get_feedback_repository().get_all()

        if not reviews:
            bot.send_message(message.chat.id, "–û—Ç–∑—ã–≤–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç.")
            return

        message_text = "üìã –í—Å–µ –æ—Ç–∑—ã–≤—ã:\n\n"
        for review in reviews:
            message_text += f"üìÖ {review.created_at.strftime('%d.%m.%Y %H:%M')}\n"
            message_text += f"üë§ @{review.user_name}\n"
            message_text += f"üìù –û—Ç–∑—ã–≤: {review.text}\n"
            message_text += "-" * 30 + "\n"

        # –†–∞–∑–±–∏–≤–∞–µ–º –Ω–∞ —á–∞—Å—Ç–∏, –µ—Å–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω–æ–µ
        max_length = 4096
        for i in range(0, len(message_text), max_length):
            chunk = message_text[i:i + max_length]
            bot.send_message(message.chat.id, chunk)

    def clear_cart(message: types.Message) -> None:
        print("clear_cart")
        order = bot.get_order_repository().get_in_cart(message.chat.id)
        if not order:
            bot.send_message(message.chat.id, "üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.")
            return

        if not order.items:
            bot.send_message(message.chat.id, "üß∫ –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.")
            return

        items = bot.get_order_item_repository().get_by_order(order.id)

        for i in items:
            print(f"deleting {i.id} {i.dish_name}")
            bot.get_order_item_repository().delete_item(i.id)
            order.del_item(i)
        bot.get_order_repository().save(order)
        bot.send_message(message.chat.id, "üß∫ –ö–æ—Ä–∑–∏–Ω–∞ –æ—á–∏—â–µ–Ω–∞.")

    #–æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
    @bot.callback_query_handler(func=lambda call: call.data and call.data.startswith("cmd_"))
    def process_command(callback_query: types.CallbackQuery) -> None:
        print("process_command")
        command: str = callback_query.data.split(":", 1)[1]
        if command == "show_menu":
            show_categories(callback_query.message)
        elif command == "show_cart":
            show_cart(callback_query.message)
        elif command == "clear_cart":
            clear_cart(callback_query.message)
        elif command == "show_orders":
            show_orders(callback_query.message)
        elif command == "add_feedback":
            leave_review(callback_query.message)
        elif command == "show_feedbacks":
            admin_reviews(callback_query.message)
        elif command == "load_menu":
            msg: types.Message = bot.send_message(
                callback_query.message.chat.id,
                "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª —Å –Ω–æ–≤—ã–º –º–µ–Ω—é:"
            )
            bot.register_next_step_handler(msg, handle_menu_file)
        elif command == "change_order_status":
            orders = bot.get_order_repository().get_orders_by_status(OrderStatus.PENDING)
            orders.extend(bot.get_order_repository().get_orders_by_status(OrderStatus.PREPARING))
            msg: types.Message = bot.send_message(
                callback_query.message.chat.id,
                "–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–∫–∞–∑, –∫–æ—Ç–æ—Ä–æ–º—É –Ω—É–∂–Ω–æ –ø—Ä–∏—Å–≤–æ–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Å—Ç–∞—Ç—É—Å:",
                reply_markup=select_order_to_change_status(orders)
            )

    @bot.message_handler(commands=['start'])
    def cmd_start(message: types.Message) -> None:
        markup = MainMenuBuilder.build_menu(message.from_user.id)
        bot.send_message(chat_id=message.chat.id, text="–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–∏ÃÜ—Å—Ç–≤–∏–µ:", reply_markup=markup)

    @bot.message_handler(commands=['help'])
    def cmd_help(message: types.Message) -> None:
        bot.send_message(chat_id=message.chat.id, text="–ù–∞–∂–º–∏—Ç–µ start, –¥–æ–±–∞–≤—å—Ç–µ –±–ª—é–¥–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –∑–∞–∫–∞–∑")

    @bot.callback_query_handler(func=lambda call: call.data and call.data.startswith("category_select:"))
    def process_category(callback_query: types.CallbackQuery) -> None:
        print("process_category")
        category_id: int = int(callback_query.data.split(":", 1)[1])
        category = bot.get_category_repository().get_by_id(category_id)
        if category:
            show_dishes_by_category(callback_query, category.id)
        else:
            response_text: str = "–ö–∞—Ç–µ–≥–æ—Ä–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
            bot.answer_callback_query(callback_query_id=callback_query.id, text=response_text)

    def show_dishes_by_category(call, category_id):
        print(f"show_dishes_by_category {category_id}")
        dishes = bot.get_dish_repository().get_by_category(category_id)

        if not dishes:
            bot.send_message(call.message.chat.id, "–ë–ª—é–¥–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
            return

        for dish in dishes:
            # –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–æ–π –ø—É—Ç—å –∫ —Ñ–æ—Ç–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
            if dish.photo_url and os.path.exists(dish.photo_url):
                photo_path = dish.photo_url
            else:
                photo_path = DEFAULT_IMG_PATH

            try:
                with open(photo_path, 'rb') as photo:
                    bot.send_photo(
                        chat_id=call.message.chat.id,
                        photo=photo,
                        caption=(
                            f"<b>{dish.name}</b>\n"
                            f"{dish.short_description}\n\n"
                            f"–¶–µ–Ω–∞: {dish.price} ‚ÇΩ"
                        ),
                        parse_mode='HTML',
                        reply_markup=get_dish_keyboard_with_add(dish.id)
                    )
            except Exception as e:
                bot.send_message(
                    call.message.chat.id,
                    f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ {dish.name}: {e}"
                )

    @bot.callback_query_handler(func=lambda call: call.data.startswith('details_'))
    def show_dish_details(call):
        print("show_dish_details")
        dish_id = int(call.data.split('_')[1])
        dish = bot.get_dish_repository().get_by_id(dish_id)
        if dish:
            # –ø–æ–ª—É—á–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π caption (–ø–æ–¥–ø–∏—Å—å –∫ —Ñ–æ—Ç–æ)
            existing_caption: str = call.message.caption or ""
            # —Ñ–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—ã–π caption, –¥–æ–ø–∏—Å—ã–≤–∞—è –æ–ø–∏—Å–∞–Ω–∏–µ –∫ —Å—Ç–∞—Ä–æ–º—É
            new_caption: str = f"{existing_caption}\n\n<b>–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ:</b>\n{dish.description}"

            bot.edit_message_caption(
                chat_id=call.message.chat.id,
                message_id=call.message.message_id,
                caption=new_caption,
                parse_mode='HTML',
                reply_markup=get_dish_keyboard(dish.id)
            )

    @bot.callback_query_handler(func=lambda call: call.data.startswith('add_'))
    def add_to_cart(call):
        print("add_to_cart")
        dish_id = int(call.data.split('_')[1])
        dish = bot.get_dish_repository().get_by_id(dish_id)

        msg = bot.send_message(
            call.message.chat.id,
            f"–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–ª—è '{dish.name}':"
        )
        bot.register_next_step_handler(msg, lambda m: ask_quantity(m, dish))

    def ask_quantity(message, dish):
        print("ask_quantity")
        try:
            quantity = int(message.text)
        except ValueError:
            bot.send_message(message.chat.id, "–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ!")
            bot.register_next_step_handler(message, lambda m: ask_quantity(m, dish))
            return

        order = bot.get_order_repository().get_in_cart(message.from_user.id)
        if not order:
            order = bot.get_order_repository().create(message.from_user.id)

        order_item = order.get_item_by_dish_id(dish.id)
        if not order_item:
            order_item = bot.get_order_item_repository().new_item(order_id=order.id, dish_id=dish.id, dish_name=dish.name, dish_price=dish.price, quantity= quantity)
        else:
            order_item.quantity += quantity
            bot.get_order_item_repository().update_quantity(order_item.id, order_item.quantity)
        order.update_item(order_item)
        bot.get_order_repository().save(order)
        text=f"–î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É:\n{dish.name} x{quantity}\n –í–∞—à–∞ –∫–æ—Ä–∑–∏–Ω–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑:\n"+order.get_order_text()
        bot.send_message(
            message.chat.id,
                text,
            reply_markup=get_continue_checkout()
        )


    @bot.callback_query_handler(func=lambda call: call.data == 'continue_shopping')
    def continue_shopping(call):
        show_categories(call.message)

    # –ü–æ–ª—É—á–µ–Ω–∏–µ –æ—Ç–∑—ã–≤–∞, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∑—ã–≤–∞ –∏ –∑–∞–ø–∏—Å—å –æ—Ç–∑—ã–≤–∞ –≤ –±–∞–∑—É –æ—Ç–∑—ã–≤–æ–≤
    @bot.message_handler(content_types=['text'])
    def handle_message(message: types.Message) -> None:
        print("handle_message")
        user_id = message.chat.id
        user_name = message.chat.username
        text = message.text

        if user_states.get(user_id) == "awaiting_review":
            bot.get_feedback_repository().new_feedback(user_id, user_name, text)
            bot.send_message(message.chat.id, "–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à –æ—Ç–∑—ã–≤!")
            user_states[user_id] = None
        else:
            bot.send_message(message.chat.id, "–Ø –Ω–µ –æ–∂–∏–¥–∞–ª —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –≤–∞—Å. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—ã.")

    @bot.callback_query_handler(func=lambda call: call.data == 'confirm_order')
    def confirm_order(call: types.CallbackQuery) -> None:
        print("confirm_order")
        user_id = call.from_user.id

        # –°–Ω–æ–≤–∞ –ø–æ–ª—É—á–∞–µ–º –∑–∞–∫–∞–∑ ‚Äî –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –æ–Ω –∏–∑–º–µ–Ω–∏–ª—Å—è
        order = bot.get_order_repository().get_in_cart(user_id)

        if not order:
            # –ï—Å–ª–∏ –∑–∞–∫–∞–∑–∞ –Ω–µ—Ç ‚Äî —Å–æ–æ–±—â–∞–µ–º
            bot.answer_callback_query(call.id, text="–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞.")
            return

        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –æ–Ω –º–æ–∂–µ—Ç –≤—ã–±—Ä–∞—Ç—å —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
        bot.send_message(
            chat_id=call.message.chat.id,
            text=f"–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –¥–ª—è –∑–∞–∫–∞–∑–∞ –Ω–æ–º–µ—Ä {order.id}:",
            reply_markup=select_payment_method_keyboard(order.id)
        )

    @bot.callback_query_handler(func=lambda call: call.data and call.data.startswith("order_change_status_select:"))
    def change_order_status(callback_query: types.CallbackQuery) -> None:
        order_id: int = int(callback_query.data.split(":", 1)[1])
        order = bot.get_order_repository().get_by_id(order_id)
        if order:
            if order.status == OrderStatus.PENDING:
                order.status = OrderStatus.PREPARING
            elif order.status == OrderStatus.PREPARING:
                order.status = OrderStatus.DONE
            bot.get_order_repository().save(order)
            bot.send_message(order.user_id, text=f"–°—Ç–∞—Ç—É—Å –≤–∞—à–µ–≥–æ –∑–∞–∫–∞–∑–∞ {order.id} –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {order.status.get_name()}")

        response_text: str = f"–°—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ {order.status.get_name()}"
        bot.send_message(chat_id=callback_query.message.chat.id, text=response_text)


    @bot.callback_query_handler(func=lambda call: call.data.startswith('select_payment_'))
    def select_payment_method(call):
        print("add_to_cart")
        data = call.data.split('_')[2]
        method = data.split(':')[0]
        order_id = int(data.split(':')[1])
        order = bot.get_order_repository().get_by_id(order_id)
        if not order:
            bot.answer_callback_query(call.id, text="–ó–∞–∫–∞–∑ –Ω–µ –Ω–∞–∏ÃÜ–¥–µ–Ω.")
            return
        if method == "cash":
            order.payment_method = PaymentMethod.CASH
        elif method == "card":
            order.payment_method = PaymentMethod.ONLINE
        # –ú–µ–Ω—è–µ–º —Å—Ç–∞—Ç—É—Å –∑–∞–∫–∞–∑–∞ –Ω–∞ "PENDING"
        order.status = OrderStatus.PENDING
        bot.get_order_repository().save(order)

        # –°–æ–æ–±—â–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏
        bot.send_message(
            chat_id=call.message.chat.id,
            text=f"‚úÖ –í–∞—à –∑–∞–∫–∞–∑ –Ω–æ–º–µ—Ä {order.id} —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –í –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è –≤–∞–º –Ω–∞–ø–∏—à–µ—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è"
        )

        text = f"üÜï –ù–æ–≤—ã–π –∑–∞–∫–∞–∑ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {order.user_id}.\n" + order.get_order_text()
        # –£–≤–µ–¥–æ–º–ª—è–µ–º –∞–¥–º–∏–Ω–æ–≤ –æ –Ω–æ–≤–æ–º –∑–∞–∫–∞–∑–µ
        from config import ADMIN_GROUP_ID
        bot.send_message(
            ADMIN_GROUP_ID,
            text
        )

    def handle_menu_file(message: types.Message) -> None:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–∏—Å–ª–∞–ª –¥–æ–∫—É–º–µ–Ω—Ç
        if not message.document:
            bot.send_message(message.chat.id, "–≠—Ç–æ –Ω–µ —Ñ–∞–π–ª. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç.")
            bot.register_next_step_handler(message, handle_menu_file)
            return

        # –°–∫–∞—á–∏–≤–∞–µ–º —Ñ–∞–π–ª
        file_info = bot.get_file(message.document.file_id)
        file_bytes: bytes = bot.download_file(file_info.file_path)

        # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
        import os
        os.makedirs("new_menus", exist_ok=True)
        file_path: str = os.path.join("new_menus", message.document.file_name)
        with open(file_path, 'wb') as f:
            f.write(file_bytes)

        # –ó–∞–≥—Ä—É–∂–∞–µ–º –º–µ–Ω—é —á–µ—Ä–µ–∑ menu_loader
        try:
            bot.menu_loader.load_menu(file_path)
            bot.send_message(message.chat.id, "‚úÖ –ù–æ–≤–æ–µ –º–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ.")
        except Exception as e:
            bot.send_message(message.chat.id, f"‚ùó –û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –º–µ–Ω—é: {e}")